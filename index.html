<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROHAN ENTERPRISE | SYSTEM CONTROLLER</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --gold: #d4af37;
            --gold-dark: #aa8c2c;
            --black: #0a0a0a;
            --panel: #111;
            --text-gray: #ccc;
            --danger: #ef4444;
            --success: #10b981;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; outline: none; }
        body { background-color: var(--black); color: var(--gold); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; inset: 0; background: #050505; z-index: 9999; display: flex; justify-content: center; align-items: center; }
        .login-card { border: 1px solid var(--gold); padding: 40px; width: 400px; text-align: center; background: #000; box-shadow: 0 0 20px rgba(212, 175, 55, 0.2); }
        .master-input { background: #111; border: 1px solid #333; color: white; padding: 12px; width: 100%; margin: 20px 0; text-align: center; font-size: 1.1rem; }
        .gold-btn { background: linear-gradient(45deg, var(--gold-dark), var(--gold)); color: black; border: none; padding: 12px 25px; font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%; letter-spacing: 1px; transition: 0.3s; }
        .gold-btn:hover { transform: scale(1.02); box-shadow: 0 0 15px var(--gold); }

        /* --- MAIN APP --- */
        #main-app { display: none; height: 100%; display: flex; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--panel); border-right: 1px solid #333; display: flex; flex-direction: column; }
        .brand { font-family: 'Cinzel', serif; font-size: 1.5rem; text-align: center; padding: 30px 0; border-bottom: 1px solid #333; color: white; }
        .brand span { color: var(--gold); }
        
        .menu-item { padding: 15px 25px; cursor: pointer; color: var(--text-gray); display: flex; align-items: center; gap: 15px; transition: 0.3s; }
        .menu-item:hover, .menu-item.active { background: rgba(212, 175, 55, 0.1); color: var(--gold); border-left: 4px solid var(--gold); }
        
        /* CONTENT */
        .content { flex: 1; padding: 30px; overflow-y: auto; background: #0f0f0f; }
        
        /* CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); border: 1px solid #333; padding: 20px; border-radius: 5px; }
        .stat-card h3 { color: var(--text-gray); font-size: 0.9rem; margin-bottom: 10px; }
        .stat-card h1 { color: var(--gold); font-size: 2rem; font-family: 'Cinzel', serif; }

        /* LICENSE GENERATOR */
        .gen-box { background: var(--panel); border: 1px solid var(--gold); padding: 25px; margin-bottom: 30px; display: flex; gap: 15px; align-items: end; }
        .input-group { flex: 1; }
        .input-group label { display: block; color: var(--text-gray); margin-bottom: 5px; font-size: 0.8rem; }
        .form-control { width: 100%; padding: 10px; background: #222; border: 1px solid #444; color: white; }
        
        /* TABLE */
        .table-container { background: var(--panel); border: 1px solid #333; border-radius: 5px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #222; color: var(--gold); padding: 15px; text-align: left; font-size: 0.85rem; text-transform: uppercase; }
        td { padding: 15px; border-bottom: 1px solid #222; color: #ddd; font-size: 0.9rem; }
        tr:hover { background: #1a1a1a; }
        
        /* ACTION BUTTONS */
        .action-btn { padding: 5px 10px; border: none; cursor: pointer; font-size: 0.75rem; font-weight: bold; margin-right: 5px; }
        .btn-block { background: rgba(239, 68, 68, 0.2); color: var(--danger); border: 1px solid var(--danger); }
        .btn-reset { background: rgba(16, 185, 129, 0.2); color: var(--success); border: 1px solid var(--success); }
        .btn-extend { background: rgba(212, 175, 55, 0.2); color: var(--gold); border: 1px solid var(--gold); }

        .status-active { color: var(--success); }
        .status-blocked { color: var(--danger); }
        .status-expired { color: gray; }

    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h1 style="font-family:'Cinzel'; margin-bottom:10px;">ROHAN ENTERPRISE</h1>
            <p style="color:gray; font-size:0.8rem; margin-bottom:20px;">SYSTEM CONTROL AUTHORIZATION</p>
            <input type="password" id="master-pass" class="master-input" placeholder="MASTER KEY">
            <button onclick="login()" class="gold-btn">ACCESS PANEL</button>
        </div>
    </div>

    <!-- 2. MAIN DASHBOARD -->
    <div id="main-app">
        <div class="sidebar">
            <div class="brand">ROHAN <span>CORP</span></div>
            <div class="menu-item active" onclick="showTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div class="menu-item" onclick="showTab('licenses')"><i class="fas fa-key"></i> License Manager</div>
            <div class="menu-item" onclick="showTab('settings')"><i class="fas fa-cogs"></i> System Settings</div>
            <div class="menu-item" style="margin-top:auto; color:var(--danger);" onclick="location.reload()"><i class="fas fa-sign-out-alt"></i> Secure Logout</div>
        </div>

        <div class="content">
            
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="page">
                <h2 style="font-family:'Cinzel'; margin-bottom:20px;">BUSINESS OVERVIEW</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>TOTAL LICENSES</h3><h1 id="total-lic">0</h1></div>
                    <div class="stat-card"><h3>ACTIVE USERS</h3><h1 id="active-lic" style="color:var(--success)">0</h1></div>
                    <div class="stat-card"><h3>REVENUE (EST)</h3><h1 id="revenue">₹0</h1></div>
                </div>
            </div>

            <!-- LICENSES TAB -->
            <div id="tab-licenses" class="page" style="display:none;">
                <h2 style="font-family:'Cinzel'; margin-bottom:20px;">LICENSE GENERATOR</h2>
                
                <!-- Generator -->
                <div class="gen-box">
                    <div class="input-group">
                        <label>Plan Validity</label>
                        <select id="plan-validity" class="form-control">
                            <option value="30">1 Month (30 Days)</option>
                            <option value="180">6 Months (180 Days)</option>
                            <option value="365">1 Year (365 Days)</option>
                            <option value="3650">Lifetime (10 Years)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Device Limit (Children)</label>
                        <select id="plan-devices" class="form-control">
                            <option value="1">1 Child</option>
                            <option value="2">2 Children</option>
                            <option value="5">5 Children (Family)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>Customer Name (Optional)</label>
                        <input type="text" id="client-name" class="form-control" placeholder="e.g. Rahul Singh">
                    </div>
                    <button onclick="generateLicense()" class="gold-btn" style="width:auto;">GENERATE KEY</button>
                </div>

                <!-- List -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Client</th>
                                <th>Expiry</th>
                                <th>Status</th>
                                <th>Admin Device</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="license-table">
                            <tr><td colspan="6" style="text-align:center;">Loading Data...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="tab-settings" class="page" style="display:none;">
                <h2 style="font-family:'Cinzel'; margin-bottom:20px;">SYSTEM SETTINGS</h2>
                <div class="stat-card">
                    <p>Master Password Reset functionality coming soon.</p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD7sJ0zu4cotmntqYzmaxROzwHmx8_ExvI",
            authDomain: "children-safty.firebaseapp.com",
            databaseURL: "https://children-safty-default-rtdb.firebaseio.com",
            projectId: "children-safty",
            storageBucket: "children-safty.firebasestorage.app",
            messagingSenderId: "466811425620",
            appId: "1:466811425620:web:7346de0e5da367adec2ec1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 1. LOGIN LOGIC ---
        function login() {
            const p = document.getElementById('master-pass').value;
            // HARDCODED MASTER PASSWORD (Change this later)
            if(p === "BOSS") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-app').style.display = 'flex';
                loadLicenses();
            } else {
                alert("INVALID MASTER KEY");
            }
        }

        // --- 2. GENERATE LICENSE ---
        function generateLicense() {
            const days = parseInt(document.getElementById('plan-validity').value);
            const limit = parseInt(document.getElementById('plan-devices').value);
            const name = document.getElementById('client-name').value || "Unknown";
            
            // Create Unique Key (e.g., ROHAN-X92A)
            const key = "ROHAN-" + Math.random().toString(36).substr(2, 6).toUpperCase();
            
            const now = Date.now();
            const expiry = now + (days * 24 * 60 * 60 * 1000);
            
            const licenseData = {
                key: key,
                clientName: name,
                created: now,
                expiry: expiry,
                deviceLimit: limit,
                status: "Active",
                adminDeviceId: "", // Will bind on first login
                adminPassword: "admin" // Default password for parent
            };

            // Save to Firebase
            db.ref('company_system/licenses/' + key).set(licenseData)
            .then(() => {
                alert("NEW LICENSE GENERATED:\n\nKEY: " + key + "\n\nGive this key to the customer.");
                loadLicenses(); // Refresh UI
            });
        }

        // --- 3. LOAD LICENSES (TABLE) ---
        function loadLicenses() {
            db.ref('company_system/licenses').on('value', snap => {
                const tbody = document.getElementById('license-table');
                tbody.innerHTML = '';
                
                let total = 0;
                let active = 0;

                if(!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No Licenses Found</td></tr>';
                    return;
                }

                snap.forEach(child => {
                    const d = child.val();
                    total++;
                    
                    // Check Status
                    let statusClass = "status-active";
                    if(d.status === "Blocked") statusClass = "status-blocked";
                    if(Date.now() > d.expiry) { d.status = "Expired"; statusClass = "status-expired"; }
                    if(d.status === "Active") active++;

                    // Format Date
                    const expDate = new Date(d.expiry).toLocaleDateString();
                    
                    // Hardware ID Text
                    const hwId = d.adminDeviceId ? `<span style="color:#aaa;font-size:0.7rem;">LOCKED: ${d.adminDeviceId.substr(0,8)}...</span>` : `<span style="color:#10b981;">[ OPEN ]</span>`;

                    const row = `
                        <tr>
                            <td style="color:white; font-weight:bold;">${d.key}</td>
                            <td>${d.clientName}</td>
                            <td>${expDate}</td>
                            <td class="${statusClass}">${d.status}</td>
                            <td>${hwId}</td>
                            <td>
                                <button class="action-btn btn-block" onclick="updateStatus('${d.key}', 'Blocked')">BLOCK</button>
                                <button class="action-btn btn-reset" onclick="resetDevice('${d.key}')">RESET ID</button>
                                <button class="action-btn btn-extend" onclick="extendTime('${d.key}')">+30D</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                // Update Stats
                document.getElementById('total-lic').innerText = total;
                document.getElementById('active-lic').innerText = active;
                document.getElementById('revenue').innerText = "₹" + (total * 500); // Dummy calc
            });
        }

        // --- 4. ACTIONS ---
        function updateStatus(key, status) {
            if(confirm(`Set status of ${key} to ${status}?`)) {
                db.ref(`company_system/licenses/${key}/status`).set(status);
            }
        }

        function resetDevice(key) {
            if(confirm(`Reset Device Lock for ${key}? Parent can login on new device.`)) {
                db.ref(`company_system/licenses/${key}/adminDeviceId`).set("");
                alert("Device Unlocked. Parent can login now.");
            }
        }

        function extendTime(key) {
            // Get current expiry first
            db.ref(`company_system/licenses/${key}/expiry`).once('value', snap => {
                const currentExp = snap.val();
                const newExp = currentExp + (30 * 24 * 60 * 60 * 1000); // Add 30 days
                db.ref(`company_system/licenses/${key}/expiry`).set(newExp);
                db.ref(`company_system/licenses/${key}/status`).set("Active"); // Reactivate if expired
                alert("Added 30 Days Validity.");
            });
        }

        // --- TABS ---
        function showTab(id) {
            document.querySelectorAll('.page').forEach(e => e.style.display = 'none');
            document.getElementById('tab-'+id).style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
