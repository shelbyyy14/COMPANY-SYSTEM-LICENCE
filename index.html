<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ROHAN SECURITY | COMMAND CENTER</title>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <!-- Icons & Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        /* --- NEW RED THEME --- */
        :root {
            --primary: #dc2626;      /* Strong Red */
            --primary-dark: #7f1d1d; /* Dark Red */
            --black: #050505;
            --panel: #111;
            --text-gray: #9ca3af;
            --white: #f3f4f6;
            --border: 1px solid #333;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Roboto', sans-serif; outline: none; }
        body { background-color: var(--black); color: var(--white); height: 100vh; display: flex; flex-direction: column; overflow: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-screen { position: fixed; inset: 0; background: #000; z-index: 9999; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(#220000 20%, #000 80%); }
        .login-card { border: 1px solid var(--primary); padding: 40px; width: 400px; text-align: center; background: #0a0a0a; box-shadow: 0 0 30px rgba(220, 38, 38, 0.2); }
        .master-input { background: #111; border: 1px solid #333; color: white; padding: 12px; width: 100%; margin: 20px 0; text-align: center; font-size: 1.1rem; transition: 0.3s; }
        .master-input:focus { border-color: var(--primary); box-shadow: 0 0 10px var(--primary-dark); }
        
        .action-btn, .theme-btn { background: linear-gradient(135deg, var(--primary), var(--primary-dark)); color: white; border: none; padding: 12px 25px; font-weight: bold; cursor: pointer; text-transform: uppercase; width: 100%; letter-spacing: 1px; transition: 0.3s; }
        .theme-btn:hover { transform: translateY(-2px); box-shadow: 0 0 20px var(--primary); }

        /* --- MAIN APP --- */
        #main-app { display: none; height: 100%; display: flex; }
        
        /* SIDEBAR */
        .sidebar { width: 250px; background: var(--panel); border-right: var(--border); display: flex; flex-direction: column; }
        .brand { font-family: 'Cinzel', serif; font-size: 1.6rem; text-align: center; padding: 30px 0; border-bottom: var(--border); color: white; text-shadow: 0 0 10px var(--primary); }
        .brand span { color: var(--primary); }
        
        .menu-item { padding: 15px 25px; cursor: pointer; color: var(--text-gray); display: flex; align-items: center; gap: 15px; transition: 0.3s; border-left: 3px solid transparent; }
        .menu-item:hover, .menu-item.active { background: rgba(220, 38, 38, 0.05); color: var(--primary); border-left: 3px solid var(--primary); }
        
        /* CONTENT */
        .content { flex: 1; padding: 30px; overflow-y: auto; background: #080808; }
        
        /* STAT CARDS */
        .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .stat-card { background: var(--panel); border: var(--border); padding: 20px; border-radius: 4px; position: relative; overflow: hidden; }
        .stat-card::after { content:''; position: absolute; top:0; left:0; width: 4px; height: 100%; background: var(--primary); }
        .stat-card h3 { color: var(--text-gray); font-size: 0.8rem; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px; }
        .stat-card h1 { color: white; font-size: 2.2rem; font-family: 'Cinzel', serif; }

        /* FORMS */
        .gen-box { background: var(--panel); border: 1px solid var(--primary-dark); padding: 25px; margin-bottom: 30px; display: flex; gap: 15px; align-items: end; flex-wrap: wrap; }
        .input-group { flex: 1; min-width: 200px; }
        .input-group label { display: block; color: var(--primary); margin-bottom: 8px; font-size: 0.8rem; font-weight: bold; }
        .form-control { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #333; color: white; }
        .form-control:focus { border-color: var(--primary); }
        
        /* TABLE */
        .table-container { background: var(--panel); border: var(--border); border-radius: 4px; overflow: hidden; }
        table { width: 100%; border-collapse: collapse; }
        th { background: #1a1a1a; color: var(--primary); padding: 15px; text-align: left; font-size: 0.8rem; text-transform: uppercase; border-bottom: 1px solid var(--primary-dark); }
        td { padding: 15px; border-bottom: 1px solid #222; color: #ccc; font-size: 0.9rem; }
        tr:hover { background: #151515; }
        
        /* TABLE BUTTONS */
        .tbl-btn { padding: 5px 10px; border: none; cursor: pointer; font-size: 0.7rem; font-weight: bold; margin-right: 5px; color: white; }
        .btn-block { background: #7f1d1d; border: 1px solid #ef4444; }
        .btn-reset { background: #064e3b; border: 1px solid #10b981; }
        
        .status-active { color: #10b981; font-weight: bold; }
        .status-blocked { color: #ef4444; font-weight: bold; }
        .status-expired { color: gray; }

    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="login-screen">
        <div class="login-card">
            <h1 style="font-family:'Cinzel'; margin-bottom:5px;">ROHAN<br><span style="color:var(--primary)">SECURITY</span></h1>
            <p style="color:gray; font-size:0.7rem; margin-bottom:20px; letter-spacing: 2px;">RESTRICTED ACCESS ONLY</p>
            
            <input type="password" id="master-pass" class="master-input" placeholder="ENTER ACCESS CODE">
            <button onclick="login()" class="theme-btn">AUTHENTICATE</button>
            <p id="login-msg" style="margin-top:15px; font-size:0.8rem; height:20px;"></p>
        </div>
    </div>

    <!-- 2. MAIN DASHBOARD -->
    <div id="main-app">
        <div class="sidebar">
            <div class="brand">ROHAN <span>CORP</span></div>
            <div class="menu-item active" onclick="showTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div class="menu-item" onclick="showTab('licenses')"><i class="fas fa-key"></i> License Center</div>
            <div class="menu-item" onclick="showTab('settings')"><i class="fas fa-satellite-dish"></i> Broadcast & Settings</div>
            <div class="menu-item" style="margin-top:auto; color:var(--primary);" onclick="location.reload()"><i class="fas fa-power-off"></i> Terminate Session</div>
        </div>

        <div class="content">
            
            <!-- DASHBOARD TAB -->
            <div id="tab-dashboard" class="page">
                <h2 style="font-family:'Cinzel'; margin-bottom:20px;">SYSTEM OVERVIEW</h2>
                <div class="stats-grid">
                    <div class="stat-card"><h3>TOTAL KEYS</h3><h1 id="total-lic">0</h1></div>
                    <div class="stat-card"><h3>ONLINE USERS</h3><h1 id="active-lic" style="color:var(--primary)">0</h1></div>
                    <div class="stat-card"><h3>REVENUE</h3><h1 id="revenue">₹0</h1></div>
                </div>
            </div>

            <!-- LICENSES TAB -->
            <div id="tab-licenses" class="page" style="display:none;">
                <h2 style="font-family:'Cinzel'; margin-bottom:20px;">KEY GENERATION PROTOCOL</h2>
                
                <!-- Generator -->
                <div class="gen-box">
                    <div class="input-group">
                        <label>KEY PREFIX (Name)</label>
                        <input type="text" id="key-prefix" class="form-control" placeholder="e.g. ROHAN (Default)">
                    </div>
                    <div class="input-group">
                        <label>VALIDITY PERIOD</label>
                        <select id="plan-validity" class="form-control">
                            <option value="30">1 Month (30 Days)</option>
                            <option value="180">6 Months</option>
                            <option value="365">1 Year</option>
                            <option value="3650">LIFETIME</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>DEVICE LIMIT</label>
                        <select id="plan-devices" class="form-control">
                            <option value="1">1 Device</option>
                            <option value="2">2 Devices</option>
                            <option value="5">5 Devices (Family)</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>CLIENT NOTE</label>
                        <input type="text" id="client-name" class="form-control" placeholder="Optional">
                    </div>
                    <button onclick="generateLicense()" class="theme-btn" style="width:auto; margin-bottom:0;">CREATE KEY</button>
                </div>

                <!-- List -->
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>License Key</th>
                                <th>Note</th>
                                <th>Expiry</th>
                                <th>Status</th>
                                <th>Devices</th>
                                <th>Controls</th>
                            </tr>
                        </thead>
                        <tbody id="license-table">
                            <tr><td colspan="6" style="text-align:center;">Loading Database...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- SETTINGS TAB -->
            <div id="tab-settings" class="page" style="display:none;">
                <h2 style="font-family:'Cinzel'; margin-bottom:20px;">GLOBAL COMMANDS</h2>
                
                <div class="gen-box" style="border-color: var(--primary);">
                    <div class="input-group" style="flex: 3;">
                        <label><i class="fas fa-broadcast-tower"></i> PUSH SYSTEM UPDATE TO ADMIN PANELS</label>
                        <input type="text" id="update-msg" class="form-control" placeholder="Enter message (e.g. 'System Maintenance in 10 mins')">
                    </div>
                    <button onclick="sendGlobalUpdate()" class="theme-btn" style="flex: 1;">SEND BROADCAST</button>
                </div>

                <div class="stat-card">
                    <h3 style="color:var(--primary);">ADMIN CONFIGURATION</h3>
                    <p style="margin-top:10px; font-size:0.9rem; color:#888;">
                        Master Password: <strong style="color:white;">[SECURE IN DATABASE]</strong><br>
                        To change password, edit Firebase Database at: <code>company_system/settings/password</code>
                    </p>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyD7sJ0zu4cotmntqYzmaxROzwHmx8_ExvI",
            authDomain: "children-safty.firebaseapp.com",
            databaseURL: "https://children-safty-default-rtdb.firebaseio.com",
            projectId: "children-safty",
            storageBucket: "children-safty.firebasestorage.app",
            messagingSenderId: "466811425620",
            appId: "1:466811425620:web:7346de0e5da367adec2ec1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // --- 1. SECURE LOGIN LOGIC ---
        function login() {
            const p = document.getElementById('master-pass').value;
            const msg = document.getElementById('login-msg');
            
            msg.style.color = "yellow";
            msg.innerText = "Verifying Credentials...";

            // Check DB for password
            db.ref('company_system/settings/password').once('value', snap => {
                let serverPass = "BOSS"; // Default Fallback
                if(snap.exists()) {
                    serverPass = snap.val();
                } else {
                    // First time setup: Set default password in DB
                    db.ref('company_system/settings/password').set("BOSS");
                }

                if(p === serverPass) {
                    msg.style.color = "#10b981";
                    msg.innerText = "ACCESS GRANTED";
                    setTimeout(() => {
                        document.getElementById('login-screen').style.display = 'none';
                        document.getElementById('main-app').style.display = 'flex';
                        loadLicenses();
                    }, 800);
                } else {
                    msg.style.color = "#ef4444";
                    msg.innerText = "ACCESS DENIED: INVALID CODE";
                }
            });
        }

        // --- 2. GENERATE CUSTOM LICENSE ---
        function generateLicense() {
            const days = parseInt(document.getElementById('plan-validity').value);
            const limit = parseInt(document.getElementById('plan-devices').value);
            const note = document.getElementById('client-name').value || "Client";
            
            // CUSTOM PREFIX LOGIC
            let prefix = document.getElementById('key-prefix').value.trim().toUpperCase();
            if(!prefix) prefix = "ROHAN"; // Default if empty
            // Remove special chars
            prefix = prefix.replace(/[^A-Z0-9]/g, '');

            const randomPart = Math.random().toString(36).substr(2, 5).toUpperCase();
            const key = `${prefix}-${randomPart}`;
            
            const now = Date.now();
            const expiry = now + (days * 24 * 60 * 60 * 1000);
            
            const licenseData = {
                key: key,
                clientName: note,
                created: now,
                expiry: expiry,
                deviceLimit: limit,
                status: "Active",
                devices: {}, // FIXED: Empty list for Multi-Device support
                adminDeviceId: "" // Kept for backward compatibility
            };

            db.ref('company_system/licenses/' + key).set(licenseData)
            .then(() => {
                alert(`KEY GENERATED: ${key}`);
                loadLicenses();
            });
        }

        // --- 3. SEND GLOBAL UPDATE ---
        function sendGlobalUpdate() {
            const msg = document.getElementById('update-msg').value;
            if(!msg) return alert("Please enter a message");
            
            if(confirm("Send this message to ALL Admin Panels?")) {
                db.ref('company_system/global_broadcast').set({
                    message: msg,
                    timestamp: Date.now(),
                    id: Math.random().toString(36).substr(2, 9)
                });
                alert("Update Signal Sent!");
                document.getElementById('update-msg').value = "";
            }
        }

        // --- 4. LOAD LICENSES ---
        function loadLicenses() {
            db.ref('company_system/licenses').on('value', snap => {
                const tbody = document.getElementById('license-table');
                tbody.innerHTML = '';
                
                let total = 0;
                let active = 0;

                if(!snap.exists()) {
                    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;">No Keys Found</td></tr>';
                    return;
                }

                snap.forEach(child => {
                    const d = child.val();
                    total++;
                    
                    let statusClass = "status-active";
                    if(d.status === "Blocked") statusClass = "status-blocked";
                    if(Date.now() > d.expiry) { d.status = "Expired"; statusClass = "status-expired"; }
                    if(d.status === "Active") active++;

                    const expDate = new Date(d.expiry).toLocaleDateString();
                    
                    // Count Connected Devices
                    let deviceCount = 0;
                    if(d.devices) deviceCount = Object.keys(d.devices).length;
                    else if(d.adminDeviceId) deviceCount = 1; // Old logic support

                    const row = `
                        <tr>
                            <td style="color:white; font-weight:bold;">${d.key}</td>
                            <td>${d.clientName}</td>
                            <td>${expDate}</td>
                            <td class="${statusClass}">${d.status}</td>
                            <td><span style="color:#aaa;">${deviceCount} / ${d.deviceLimit}</span></td>
                            <td>
                                <button class="tbl-btn btn-block" onclick="updateStatus('${d.key}', 'Blocked')">BLOCK</button>
                                <button class="tbl-btn btn-reset" onclick="resetDevice('${d.key}')">RESET</button>
                                <button class="tbl-btn" style="background:#333;" onclick="extendTime('${d.key}')">+30D</button>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });

                document.getElementById('total-lic').innerText = total;
                document.getElementById('active-lic').innerText = active;
                document.getElementById('revenue').innerText = "₹" + (total * 500); 
            });
        }

        // --- ACTIONS ---
        function updateStatus(key, status) {
            if(confirm(`Set status of ${key} to ${status}?`)) {
                db.ref(`company_system/licenses/${key}/status`).set(status);
            }
        }

        function resetDevice(key) {
            if(confirm(`Remove ALL devices from ${key}?`)) {
                db.ref(`company_system/licenses/${key}/devices`).remove();
                db.ref(`company_system/licenses/${key}/adminDeviceId`).set(""); // Clear old
                alert("Devices Cleared.");
            }
        }

        function extendTime(key) {
            db.ref(`company_system/licenses/${key}/expiry`).once('value', snap => {
                const currentExp = snap.val();
                const newExp = currentExp + (30 * 24 * 60 * 60 * 1000); 
                db.ref(`company_system/licenses/${key}/expiry`).set(newExp);
                db.ref(`company_system/licenses/${key}/status`).set("Active");
                alert("Extended +30 Days");
            });
        }

        function showTab(id) {
            document.querySelectorAll('.page').forEach(e => e.style.display = 'none');
            document.getElementById('tab-'+id).style.display = 'block';
            document.querySelectorAll('.menu-item').forEach(e => e.classList.remove('active'));
            event.currentTarget.classList.add('active');
        }
    </script>
</body>
</html>
